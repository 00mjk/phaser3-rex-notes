!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).rexparse=e()}(this,function(){"use strict";function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function s(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function c(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function e(n){return new Promise(function(t,e){!function(t,e){for(var n=document.getElementsByTagName("script"),r=0,i=n.length;r<i;r++)if(-1!=n[r].src.indexOf(t))return e&&e();var s=document.createElement("script");s.setAttribute("src",t),e&&(s.onload=e),document.head.appendChild(s)}(n,t)})}function o(t,e,n){return void 0===e&&(e=0),void 0===n&&(n=1/0),l(t,n,e,[])}var n=function(){function n(){r(this,n)}return s(n,[{key:"initializeApp",value:function(t){return firebase.initializeApp(t),this}}],[{key:"register",value:function(t,e){n.prototype[t]=e}}]),n}(),a="https://cdnjs.cloudflare.com/ajax/libs/parse/".concat("2.9.1","/parse.min.js"),f=function(t,e,n){if(t&&"number"!=typeof t){if(t.hasOwnProperty(e))return t[e];if(-1===e.indexOf("."))return n;for(var r=e.split("."),i=t,s=n,o=0;o<r.length;o++){if(!i.hasOwnProperty(r[o])){s=n;break}s=i[r[o]],i=i[r[o]]}return s}return n},l=function n(r,i,s,o){var a=Math.min(i,1e3);return i-=a,r.skip(s).limit(a).find().then(function(t){if(o.push.apply(o,c(t)),0===i||t.length<a)return Promise.resolve(o);var e=s+t.length;return n(r,i,e,o)})},t={loadItems:function(e,n){void 0===e&&(e=0),void 0===n&&(n=1/0),this.items.length=0;var r=this;return o(this.query,e,n).then(function(t){return r.items=t,r.startIndex=e,r.pageIndex=Math.floor(e/r.itemCount),r.isLastPage=n===1/0||n>t.length,Promise.resolve(t)}).catch(function(t){return r.isLastPage=!1,Promise.reject(t)})},loadPage:function(t){var e=t*this.itemCount;return this.loadItems(e,this.itemCount)},loadCurrentPage:function(){return this.loadItems(this.startIndex,this.itemCount)},loadNextPage:function(){var t=this.startIndex+this.itemCount;return this.loadItems(t,this.itemCount)},loadPreviousPage:function(){var t=this.startIndex-this.itemCount;return this.loadItems(t,this.itemCount)}},h=function(){function e(t){r(this,e),this.items=[],this.startIndex=0,this.pageIndex=0,this.isLastPage=!1,this.setItemCount(f(t,"itemCount",100)),this.setQuery(f(t,"query",void 0))}return s(e,[{key:"setItemCount",value:function(t){return this.itemCount=t,this.pageIndex=Math.floor(this.startIndex/t),this}},{key:"setQuery",value:function(t){return this.query=t,this}},{key:"getItem",value:function(t){return this.items[t-this.startIndex]}},{key:"findFirst",value:function(t,e){for(var n,r=this.items.length;n<r;n++)if(this.items[n].get(t)===e)return n+this.startIndex;return-1}}]),e}();Object.assign(h.prototype,t);function d(t){return null==t||""===t||0===t.length}function y(t,e,n){if("object"===u(t))if(d(e)){if(null==n)return;"object"===u(n)&&(t=n)}else{"string"==typeof e&&(e=e.split("."));var r=e.pop();(function(t,e,n){void 0===n&&(n={});var r=t;if(d(e));else{var i;"string"==typeof e&&(e=e.split("."));for(var s=0,o=e.length;s<o;s++){var a;if(null==r[i=e[s]]||"object"!==u(r[i]))a=s===o-1?n:{},r[i]=a;r=r[i]}}return r})(t,e)[r]=n}}n.register("pageLoader",function(t){return new h(t)}),y(window,"RexPlugins.Parse.PageLoader",h);function m(t,e){var n;if(t instanceof e)n=t;else for(var r in n=new e,t)n.set(r,t[r]);return n}function p(t,e,n){if(!e&&!n)return t;var r=Parse.User.current();if(!r)return t;var i=new Parse.ACL(r);return n||i.setPublicWriteAccess(!0),e||i.setPublicReadAccess(!0),t.setACL(i),t}var g=function(t){for(var e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1)),r=t[e];t[e]=t[n],t[n]=r}return t},v={loadItem:function(t){return this.baseQuery.get(t)},loadPage:function(t){return this.pageLoader.loadPage(t)},loadCurrentPage:function(){return this.pageLoader.loadCurrentPage()},loadNextPage:function(){return this.pageLoader.loadNextPage()},loadPreviousPage:function(){return this.pageLoader.loadPreviousPage()},loadItems:function(t,e){return this.pageLoader.loadItems(t,e)},load:function(t){return void 0===t&&(t=this.baseQuery),o(t)},loadRandomItems:function(r,i){"number"==typeof r&&(i=r,r=void 0),void 0===r&&(r=this.baseQuery),void 0===i&&(i=1),r.select("id");var s=this;return o(r).then(function(t){g(t),i=Math.min(i,t.length);for(var e=[],n=0;n<i;n++)e.push(t[n].id);return r=s.baseQuery.containedIn("objectId",e),o(r)})}},b={deleteItem:function(t){return this.createItem().set("id",t).destroy()},delete:function(t){return void 0===t&&(t=this.baseQuery),function(t){return t.select("id"),o(t).then(function(t){return 0===t.length?Promise.resolve():Parse.Object.destroyAll(t)})}(t)}},P=function(t){for(var e,n,r=this.baseQuery.select("id"),i=t instanceof this.customClass,s=0,o=this.primaryKeys.length;s<o;s++)e=this.primaryKeys[s],n=i?t.get(e):t[e],r.equalTo(e,n);return r},I=function(t){var e=m(t,this.customClass);return p(e,this.ownerRead,this.ownerWrite),e.save()},w=function(){function n(t){r(this,n),this.pageLoader=new h,this.setClassName(f(t,"className","Item")),this.setItemCount(f(t,"itemCount",100)),this.setQuery(),this.primaryKeys=[];var e=f(t,"primaryKeys",void 0);e&&this.setPrimaryKey(e),this.setOwnerReadMode(f(t,"ownerRead",void 0)),this.setOwnerWriteMode(f(t,"ownerWrite",void 0))}return s(n,[{key:"setClassName",value:function(t){return this.customClass=Parse.Object.extend(t),this}},{key:"setPrimaryKey",value:function(t){return t?"string"==typeof t?(this.primaryKeys.length=1,this.primaryKeys[0]=t):function(t,e,n,r){void 0===n&&(n=0),void 0===r&&(r=e.length),t.length=r-n;for(var i=0,s=t.length;i<s;i++)t[i]=e[i+n]}(this.primaryKeys,t):this.primaryKeys.length=0,this}},{key:"setOwnerReadMode",value:function(t){return this.ownerRead=t,this}},{key:"setOwnerWriteMode",value:function(t){return this.ownerWrite=t,this}},{key:"createItem",value:function(){return new this.customClass}},{key:"setItemCount",value:function(t){return this.pageLoader.setItemCount(t),this}},{key:"setQuery",value:function(t){return void 0===t&&(t=this.baseQuery),this.pageLoader.setQuery(t),this}},{key:"baseQuery",get:function(){return new Parse.Query(this.customClass)}},{key:"startIndex",get:function(){return this.pageLoader.startIndex}},{key:"pageIndex",get:function(){return this.pageLoader.pageIndex}},{key:"isLastPage",get:function(){return this.pageLoader.isLastPage}}]),n}(),C={save:function(n){if(function(t){return"[object Array]"===Object.prototype.toString.call(t)}(n))return this.saveItems(n);if(0<this.primaryKeys.length){var r=this;return P.call(this,n).first().then(function(t){if(t){var e=t.id;n instanceof r.customClass?n.set("id",e):n.id=e}return I.call(r,n)})}return I.call(this,n)},saveItems:function(t){if(0<this.primaryKeys.length){for(var e=[],n=0,r=t.length;n<r;n++)e.push(this.save(t[n]));return Promise.all(e)}var i,s=[];for(n=0,r=t.length;n<r;n++)i=m(t[n],this.customClass),p(i,this.ownerRead,this.ownerWrite),s.push(i);return Parse.Object.saveAll(s)},getItemCount:function(t){return void 0===t&&(t=this.baseQuery),t.count()}};Object.assign(w.prototype,v,b,C),n.register("itemTable",function(t){return new w(t)}),y(window,"RexPlugins.Parse.ItemTable",w);var x=function(t,e){var n=new Parse.User;return n.set("username",t).set("password",e),n.signUp().then(function(){return Parse.User.logIn(t,e)})},k=function(){function t(){r(this,t),this.add=new n}return s(t,[{key:"preload",value:function(t){return function(t){return void 0===t&&(t=a),e(t)}(t)}}]),t}(),j={quickLogin:function(t,e){return Parse.User.logOut().then(function(){return Parse.User.logIn(t,e)}).catch(function(){return x(t,e)})}};return Object.assign(k.prototype,j),k});
