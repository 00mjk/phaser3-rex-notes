!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).rexvideoplugin=t()}(this,function(){"use strict";function h(e){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?o(e):t}function a(e,t,i){return(a="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}})(e,t,i||e)}function e(e){return function(){function r(){return u(this,r),d(this,c(r).apply(this,arguments))}return n(r,e),t(r,[{key:"createVideoElement",value:function(e){return this.video||(void 0===e&&(e={}),(e.eventEmitter=this).video=function(e){var t,i,r=this,n=document.createElement("video");for(var s in v)t=v[s],void 0!==(i=l(e,s,t[1]))&&(n[t[0]]=i);var a=l(e,"eventEmitter",void 0);if(a){var o=function(e){n.addEventListener(f[e],function(){a.emit(e,this)}.bind(r))};for(var h in f)o(h)}return n}(e),this.playbackTimeChangeEventEnable=s(e,"playbackTimeChangeEventEnable",!0)),this.video}},{key:"preDestroy",value:function(){this.scene&&(this.video&&(this.video.pause(),this.video.removeAttribute("src"),this.video.load(),this.video=void 0),a(c(r.prototype),"preDestroy",this)&&a(c(r.prototype),"preDestroy",this).call(this))}},{key:"preUpdate",value:function(e,t){if(this.playbackTimeChangeEventEnable){var i=this.playbackTime;i!==this.prevT&&this.emit("playbacktimechange",this),this.prevT=i}a(c(r.prototype),"preUpdate",this)&&a(c(r.prototype),"preUpdate",this).call(this,e,t)}},{key:"load",value:function(e){return this.video&&function(e,t,i){if(p(t))for(var r,n=0,s=y.length;n<s;n++)if(i[r=y[n]]&&t.hasOwnProperty(r)){t=t[r];break}e.src=t,e.load()}(this.video,e,this.availableVideoTypes),this}},{key:"play",value:function(){return this.video&&this.video.play(),this}},{key:"pause",value:function(){return this.video&&this.video.pause(),this}},{key:"setPlaybackTime",value:function(e){return this.playbackTime=e,this}},{key:"setT",value:function(e){return this.t=e,this}},{key:"setVolume",value:function(e){return this.volume=e,this}},{key:"setMute",value:function(e){return void 0===e&&(e=!0),this.muted=e,this}},{key:"setLoop",value:function(e){return void 0===e&&(e=!0),this.loop=e,this}},{key:"availableVideoTypes",get:function(){return this.scene.sys.game.device.video}},{key:"isPlaying",get:function(){if(this.video){var e=this.video;return!e.paused&&!e.ended&&0<e.currentTime}return!1}},{key:"isPaused",get:function(){return!!this.video&&this.video.paused}},{key:"playbackTime",get:function(){return this.video&&this.video.currentTime||0},set:function(e){if(this.video)try{this.video.currentTime=e}catch(e){}}},{key:"duration",get:function(){return this.video&&this.video.duration||0}},{key:"t",get:function(){if(this.video){var e=this.duration;return 0===e?0:this.playbackTime/e}return 0},set:function(e){this.video&&(this.playbackTime=this.duration*g(e,0,1))}},{key:"hasEnded",get:function(){return!!this.video&&this.video.ended}},{key:"volume",get:function(){return this.video&&this.video.volume||0},set:function(e){this.video&&(this.video.volume=e)}},{key:"muted",get:function(){return this.video&&this.video.muted||!1},set:function(e){this.video&&(this.video.muted=e)}},{key:"loop",get:function(){return!!this.video&&this.video.loop},set:function(e){this.video&&(this.video.loop=e)}},{key:"readyState",get:function(){return this.video?this.video.readyState:void 0}}]),r}()}var l=Phaser.Utils.Objects.GetValue,v={id:["id",void 0],width:["width",void 0],height:["height",void 0],autoPlay:["autoplay",!0],controls:["controls",!1],loop:["loop",!1],poster:["poster",void 0],preload:["preload",void 0],muted:["muted",!1],playsInline:["playsInline",!0],crossOrigin:["crossOrigin","anonymous"]},f={canplay:"canplay",canplaythrough:"canplaythrough",ended:"ended",error:"error",loadstart:"loadstart",playing:"playing",pause:"pause",stalled:"stalled"},p=Phaser.Utils.Objects.IsPlainObject,y=["webm","ogg","mp4","h264","vp9","hls"],s=Phaser.Utils.Objects.GetValue,g=Phaser.Math.Clamp,m=Phaser.GameObjects.DOMElement,b=Phaser.Utils.Objects.IsPlainObject,x=Phaser.Utils.Objects.GetValue,w=function(){function h(e,t,i,r,n,s){var a;u(this,h),b(t)?(t=x(s=t,"x",0),i=x(s,"y",0),r=x(s,"width",void 0),n=x(s,"height",void 0)):b(r)&&(r=x(s=r,"width",void 0),n=x(s,"height",void 0)),void 0===s&&(s={});var o=e.scale.autoRound;return void 0!==r&&(o&&(r=Math.floor(r)),s.width=r),void 0!==n&&(o&&(n=Math.floor(n)),s.height=n),(a=d(this,c(h).call(this,e,t,i))).type="rexVideo",a.setElement(a.createVideoElement(s)).load(x(s,"src","")),a}return n(h,e(m)),t(h,[{key:"resize",value:function(e,t){return this.width===e&&this.height===t||(this.node.width=e,this.node.height=t,this.updateSize()),this}}]),h}();function T(e,t,i,r,n){var s=new w(this.scene,e,t,i,r,n);return this.scene.add.existing(s),s}var O=Phaser.Utils.Objects.GetAdvancedValue,P=Phaser.GameObjects.BuildGameObject;function k(e,t){var i=O(e,"width",void 0),r=O(e,"height",void 0);void 0!==t&&(e.add=t);var n=new w(this.scene,0,0,i,r,e);return P(this.scene,n,e),n}function j(){}var C=Phaser.Renderer.WebGL.Utils,E=j,R=j;WEBGL_RENDERER&&(E=function(e,t,i,r,n){if(t.dirty&&(t.updateTexture(),t.dirty=!1),0!==t.width&&0!==t.height){var s=t.frame,a=s.width,o=s.height,h=C.getTintAppendFloatAlpha;this.pipeline.batchTexture(t,s.glTexture,a,o,t.x,t.y,a/t.resolution,o/t.resolution,t.scaleX,t.scaleY,t.rotation,t.flipX,t.flipY,t.scrollFactorX,t.scrollFactorY,t.displayOriginX,t.displayOriginY,0,0,a,o,h(t._tintTL,r.alpha*t._alphaTL),h(t._tintTR,r.alpha*t._alphaTR),h(t._tintBL,r.alpha*t._alphaBL),h(t._tintBR,r.alpha*t._alphaBR),t._isTinted&&t.tintFill,0,0,r,n)}}),CANVAS_RENDERER&&(R=function(e,t,i,r,n){0!==t.width&&0!==t.height&&e.batchSprite(t,t.frame,r,n)});var G={renderWebGL:E,renderCanvas:R},_=Phaser.Display.Color,S={clear:function(){return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.dirty=!0,this},fill:function(e){return this.context.fillStyle=e,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.dirty=!0,this},getPixel:function(e,t,i){void 0===i&&(i=new _);var r=this.context.getImageData(e,t,1,1);return i.setTo(r.data[0],r.data[1],r.data[2],r.data[3]),i},setPixel:function(e,t,i,r,n,s){if("number"!=typeof i){var a=i;i=a.red,r=a.green,n=a.blue,s=a.alpha}void 0===s&&(s=0!==i||0!==r||0!==n?255:0);var o=this.context.createImageData(1,1);return o.data[0]=i,o.data[1]=r,o.data[2]=n,o.data[3]=s,this.context.putImageData(o,e,t),this.dirty=!0,this}},V={updateTexture:function(e,t){e&&(t?e.call(t,this.canvas,this.context):e(this.canvas,this.context)),this.canvas.width===this.frame.width&&this.canvas.height===this.frame.height||this.frame.setSize(this.canvas.width,this.canvas.height),this.renderer.gl&&(this.frame.source.glTexture=this.renderer.canvasToTexture(this.canvas,this.frame.source.glTexture,!0),this.frame.glTexture=this.frame.source.glTexture),this.dirty=!1;var i=this.input;return i&&!i.customHitArea&&(i.hitArea.width=this.width,i.hitArea.height=this.height),this},generateTexture:function(e,t,i,r,n){var s,a=this.canvas,o=this.scene.sys,h=o.game.renderer;void 0===t&&(t=0),void 0===i&&(i=0),void 0===r?r=a.width:r*=this.resolution,void 0===n?n=a.height:n*=this.resolution;var u=(s=o.textures.exists(e)?o.textures.get(e):o.textures.createCanvas(e,r,n)).getSourceImage();u.width!==r&&(u.width=r),u.height!==n&&(u.height=n);var c=u.getContext("2d");return c.clearRect(0,0,r,n),c.drawImage(a,t,i,r,n),h.gl&&s&&h.canvasToTexture(u,s.source[0].glTexture,!0,0),this},loadTexture:function(e,t){var i=this.scene.textures.getFrame(e,t);return i&&(this.width!==i.cutWidth||this.height!==i.cutHeight?this.resize(i.cutWidth,i.cutHeight):this.context.clearRect(0,0,i.cutWidth,i.cutHeight),this.context.drawImage(i.source.image,i.cutX,i.cutY,i.cutWidth,i.cutHeight,0,0,this.canvas.width,this.canvas.height),this.dirty=!0),this}},D=Phaser.Display.Canvas.CanvasPool,U=Phaser.GameObjects.GameObject,I=function(){function a(e,t,i,r,n){var s;return u(this,a),void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===n&&(n=1),(s=d(this,c(a).call(this,e,"rexCanvas"))).renderer=e.sys.game.renderer,s.resolution=e.sys.game.config.resolution,s.canvas=D.create(o(s),s.resolution*r,s.resolution*n),s.context=s.canvas.getContext("2d"),s.dirty=!1,s.setPosition(t,i),s.setSize(r,n),s.setOrigin(.5,.5),s.initPipeline(),s._crop=s.resetCropObject(),s.texture=e.sys.textures.addCanvas(null,s.canvas,!0),s.frame=s.texture.get(),s.frame.source.resolution=s.resolution,s.renderer&&s.renderer.gl&&(s.renderer.deleteTexture(s.frame.source.glTexture),s.frame.source.glTexture=null),s.dirty=!0,e.sys.game.events.on("contextrestored",function(){this.dirty=!0},o(s)),s}return n(a,U),t(a,[{key:"getCanvas",value:function(e){return e||(this.dirty=!0),this.canvas}},{key:"needRedraw",value:function(){return this.dirty=!0,this}},{key:"preDestroy",value:function(){D.remove(this.canvas)}},{key:"resize",value:function(e,t){return this.width===e&&this.height===t||(this.setSize(e,t).updateDisplayOrigin(),e*=this.resolution,t*=this.resolution,e=Math.max(Math.ceil(e),1),t=Math.max(Math.ceil(t),1),this.canvas.width=e,this.canvas.height=t,this.dirty=!0),this}}]),a}(),M=Phaser.GameObjects.Components;Phaser.Class.mixin(I,[M.Alpha,M.BlendMode,M.ComputedSize,M.Crop,M.Depth,M.Flip,M.GetBounds,M.Mask,M.Origin,M.Pipeline,M.ScrollFactor,M.Tint,M.Transform,M.Visible,G,S,V]);var B=Phaser.Utils.Objects.IsPlainObject,L=Phaser.Utils.Objects.GetValue,A=function(){function h(e,t,i,r,n,s){var a;u(this,h),B(t)?(t=L(s=t,"x",0),i=L(s,"y",0),r=L(s,"width",void 0),n=L(s,"height",void 0)):B(r)&&(r=L(s=r,"width",void 0),n=L(s,"height",void 0)),void 0===s&&(s={});var o=e.scale.autoRound;return void 0!==r&&(o&&(r=Math.floor(r)),s.width=r),void 0!==n&&(o&&(n=Math.floor(n)),s.height=n),(a=d(this,c(h).call(this,e,t,i,r,n))).type="rexVideoCanvas",a.createVideoElement(s),a.load(L(s,"src","")),a}return n(h,e(I)),t(h,[{key:"renderWebGL",value:function(e,t,i,r,n){if(0<this.readyState)this.renderer.canvasToTexture(this.video,this.frame.source.glTexture,!0),this.frame.glTexture=this.frame.source.glTexture;else{var s=(e=this.renderer).gl;s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),e.setFramebuffer(null,!0)}a(c(h.prototype),"renderWebGL",this).call(this,e,t,i,r,n)}},{key:"renderCanvas",value:function(e,t,i,r,n){0<this.readyState?this.context.drawImage(this.video,0,0,this.canvas.width,this.canvas.height):this.context.clearRect(0,0,this.canvas.width,this.canvas.height),a(c(h.prototype),"renderCanvas",this).call(this,e,t,i,r,n)}},{key:"resize",value:function(e,t){return this.width===e&&this.height===t||(this.video.width=e,this.video.height=t,a(c(h.prototype),"resize",this).call(this,e,t)),this}}]),h}();function z(e,t,i,r,n){var s=new A(this.scene,e,t,i,r,n);return this.scene.add.existing(s),s}var F=Phaser.Utils.Objects.GetAdvancedValue,W=Phaser.GameObjects.BuildGameObject;function H(e,t){var i=F(e,"width",void 0),r=F(e,"height",void 0);void 0!==t&&(e.add=t);var n=new A(this.scene,0,0,i,r,e);return W(this.scene,n,e),n}function X(e){return null==e||""===e||0===e.length}function Y(e,t,i){if("object"===h(e))if(X(t)){if(null==i)return;"object"===h(i)&&(e=i)}else{"string"==typeof t&&(t=t.split("."));var r=t.pop();(function(e,t,i){void 0===i&&(i={});var r=e;if(X(t));else{var n;"string"==typeof t&&(t=t.split("."));for(var s=0,a=t.length;s<a;s++){var o;if(null==r[n=t[s]]||"object"!==h(r[n]))o=s===a-1?i:{},r[n]=o;r=r[n]}}return r})(e,t)[r]=i}}var N=function(){function i(e){var t;return u(this,i),t=d(this,c(i).call(this,e)),e.registerGameObject("rexVideo",T,k),e.registerGameObject("rexVideoCanvas",z,H),t}return n(i,Phaser.Plugins.BasePlugin),t(i,[{key:"start",value:function(){this.game.events.once("destroy",this.destroy,this)}}]),i}();return Y(window,"RexPlugins.GameObjects.Video",w),Y(window,"RexPlugins.GameObjects.VideoCanvas",A),N});
