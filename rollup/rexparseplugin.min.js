!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).rexparseplugin=e()}(this,function(){"use strict";function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function t(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&n(t,e)}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function n(t,e){return(n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function c(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(n){return new Promise(function(t,e){!function(t,e){for(var n=document.getElementsByTagName("script"),r=0,i=n.length;r<i;r++)if(-1!=n[r].src.indexOf(t))return e&&e();var o=document.createElement("script");o.setAttribute("src",t),e&&(o.onload=e),document.head.appendChild(o)}(n,t)})}function l(n){return this.addFile(new y(this,{config:{callback:function(t,e){return function(t){return void 0===t&&(t=h),a(t)}(n).then(function(){setTimeout(t,0)}).catch(e)}}})),this}function f(t,e,n){return void 0===e&&(e=0),void 0===n&&(n=1/0),g(t,n,e,[])}var h="https://cdnjs.cloudflare.com/ajax/libs/parse/".concat("2.9.1","/parse.min.js"),d=Phaser.Loader.FILE_POPULATED,y=function(){function n(t,e){return r(this,n),e.hasOwnProperty("type")||(e.type="await"),e.hasOwnProperty("url")||(e.url=""),e.hasOwnProperty("key")||(e.key=(new Date).getTime().toString()),s(this,o(n).call(this,t,e))}return e(n,Phaser.Loader.File),t(n,[{key:"load",value:function(){if(this.state===d)this.loader.nextFile(this,!0);else{var t=this.config,e=t.callback,n=t.scope,r=this.onLoad.bind(this),i=this.onError.bind(this);e?n?e.call(n,r,i):e(r,i):this.onLoad()}}},{key:"onLoad",value:function(){this.loader.nextFile(this,!0)}},{key:"onError",value:function(){this.loader.nextFile(this,!1)}}]),n}(),p=function(){function n(){r(this,n)}return t(n,[{key:"initializeApp",value:function(t){return firebase.initializeApp(t),this}}],[{key:"register",value:function(t,e){n.prototype[t]=e}}]),n}(),m=function(t,e,n){if(t&&"number"!=typeof t){if(t.hasOwnProperty(e))return t[e];if(-1===e.indexOf("."))return n;for(var r=e.split("."),i=t,o=n,s=0;s<r.length;s++){if(!i.hasOwnProperty(r[s])){o=n;break}o=i[r[s]],i=i[r[s]]}return o}return n},g=function n(r,i,o,s){var a=Math.min(i,1e3);return i-=a,r.skip(o).limit(a).find().then(function(t){if(s.push.apply(s,c(t)),0===i||t.length<a)return Promise.resolve(s);var e=o+t.length;return n(r,i,e,s)})},v={loadItems:function(e,n){void 0===e&&(e=0),void 0===n&&(n=1/0),this.items.length=0;var r=this;return f(this.query,e,n).then(function(t){return r.items=t,r.startIndex=e,r.pageIndex=Math.floor(e/r.itemCount),r.isLastPage=n===1/0||n>t.length,Promise.resolve(t)}).catch(function(t){return r.isLastPage=!1,Promise.reject(t)})},loadPage:function(t){var e=t*this.itemCount;return this.loadItems(e,this.itemCount)},loadCurrentPage:function(){return this.loadItems(this.startIndex,this.itemCount)},loadNextPage:function(){var t=this.startIndex+this.itemCount;return this.loadItems(t,this.itemCount)},loadPreviousPage:function(){var t=this.startIndex-this.itemCount;return this.loadItems(t,this.itemCount)}},b=function(){function e(t){r(this,e),this.items=[],this.startIndex=0,this.pageIndex=0,this.isLastPage=!1,this.setItemCount(m(t,"itemCount",100)),this.setQuery(m(t,"query",void 0))}return t(e,[{key:"setItemCount",value:function(t){return this.itemCount=t,this.pageIndex=Math.floor(this.startIndex/t),this}},{key:"setQuery",value:function(t){return this.query=t,this}},{key:"getItem",value:function(t){return this.items[t-this.startIndex]}},{key:"findFirst",value:function(t,e){for(var n,r=this.items.length;n<r;n++)if(this.items[n].get(t)===e)return n+this.startIndex;return-1}}]),e}();Object.assign(b.prototype,v);function P(t){return null==t||""===t||0===t.length}function w(t,e,n){if("object"===u(t))if(P(e)){if(null==n)return;"object"===u(n)&&(t=n)}else{"string"==typeof e&&(e=e.split("."));var r=e.pop();(function(t,e,n){void 0===n&&(n={});var r=t;if(P(e));else{var i;"string"==typeof e&&(e=e.split("."));for(var o=0,s=e.length;o<s;o++){var a;if(null==r[i=e[o]]||"object"!==u(r[i]))a=o===s-1?n:{},r[i]=a;r=r[i]}}return r})(t,e)[r]=n}}p.register("pageLoader",function(t){return new b(t)}),w(window,"RexPlugins.Parse.PageLoader",b);function I(t,e){var n;if(t instanceof e)n=t;else for(var r in n=new e,t)n.set(r,t[r]);return n}function C(t,e,n){if(!e&&!n)return t;var r=Parse.User.current();if(!r)return t;var i=new Parse.ACL(r);return n||i.setPublicWriteAccess(!0),e||i.setPublicReadAccess(!0),t.setACL(i),t}var O=function(t){for(var e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1)),r=t[e];t[e]=t[n],t[n]=r}return t},x={loadItem:function(t){return this.baseQuery.get(t)},loadPage:function(t){return this.pageLoader.loadPage(t)},loadCurrentPage:function(){return this.pageLoader.loadCurrentPage()},loadNextPage:function(){return this.pageLoader.loadNextPage()},loadPreviousPage:function(){return this.pageLoader.loadPreviousPage()},loadItems:function(t,e){return this.pageLoader.loadItems(t,e)},load:function(t){return void 0===t&&(t=this.baseQuery),f(t)},loadRandomItems:function(r,i){"number"==typeof r&&(i=r,r=void 0),void 0===r&&(r=this.baseQuery),void 0===i&&(i=1),r.select("id");var o=this;return f(r).then(function(t){O(t),i=Math.min(i,t.length);for(var e=[],n=0;n<i;n++)e.push(t[n].id);return r=o.baseQuery.containedIn("objectId",e),f(r)})}},k={deleteItem:function(t){return this.createItem().set("id",t).destroy()},delete:function(t){return void 0===t&&(t=this.baseQuery),function(t){return t.select("id"),f(t).then(function(t){return 0===t.length?Promise.resolve():Parse.Object.destroyAll(t)})}(t)}},L=function(t){for(var e,n,r=this.baseQuery.select("id"),i=t instanceof this.customClass,o=0,s=this.primaryKeys.length;o<s;o++)e=this.primaryKeys[o],n=i?t.get(e):t[e],r.equalTo(e,n);return r},j=function(t){var e=I(t,this.customClass);return C(e,this.ownerRead,this.ownerWrite),e.save()},A=function(){function n(t){r(this,n),this.pageLoader=new b,this.setClassName(m(t,"className","Item")),this.setItemCount(m(t,"itemCount",100)),this.setQuery(),this.primaryKeys=[];var e=m(t,"primaryKeys",void 0);e&&this.setPrimaryKey(e),this.setOwnerReadMode(m(t,"ownerRead",void 0)),this.setOwnerWriteMode(m(t,"ownerWrite",void 0))}return t(n,[{key:"setClassName",value:function(t){return this.customClass=Parse.Object.extend(t),this}},{key:"setPrimaryKey",value:function(t){return t?"string"==typeof t?(this.primaryKeys.length=1,this.primaryKeys[0]=t):function(t,e,n,r){void 0===n&&(n=0),void 0===r&&(r=e.length),t.length=r-n;for(var i=0,o=t.length;i<o;i++)t[i]=e[i+n]}(this.primaryKeys,t):this.primaryKeys.length=0,this}},{key:"setOwnerReadMode",value:function(t){return this.ownerRead=t,this}},{key:"setOwnerWriteMode",value:function(t){return this.ownerWrite=t,this}},{key:"createItem",value:function(){return new this.customClass}},{key:"setItemCount",value:function(t){return this.pageLoader.setItemCount(t),this}},{key:"setQuery",value:function(t){return void 0===t&&(t=this.baseQuery),this.pageLoader.setQuery(t),this}},{key:"baseQuery",get:function(){return new Parse.Query(this.customClass)}},{key:"startIndex",get:function(){return this.pageLoader.startIndex}},{key:"pageIndex",get:function(){return this.pageLoader.pageIndex}},{key:"isLastPage",get:function(){return this.pageLoader.isLastPage}}]),n}(),Q={save:function(n){if(function(t){return"[object Array]"===Object.prototype.toString.call(t)}(n))return this.saveItems(n);if(0<this.primaryKeys.length){var r=this;return L.call(this,n).first().then(function(t){if(t){var e=t.id;n instanceof r.customClass?n.set("id",e):n.id=e}return j.call(r,n)})}return j.call(this,n)},saveItems:function(t){if(0<this.primaryKeys.length){for(var e=[],n=0,r=t.length;n<r;n++)e.push(this.save(t[n]));return Promise.all(e)}var i,o=[];for(n=0,r=t.length;n<r;n++)i=I(t[n],this.customClass),C(i,this.ownerRead,this.ownerWrite),o.push(i);return Parse.Object.saveAll(o)},getItemCount:function(t){return void 0===t&&(t=this.baseQuery),t.count()}};Object.assign(A.prototype,x,k,Q),p.register("itemTable",function(t){return new A(t)}),w(window,"RexPlugins.Parse.ItemTable",A);var K=function(t,e){var n=new Parse.User;return n.set("username",t).set("password",e),n.signUp().then(function(){return Parse.User.logIn(t,e)})},R=function(){function n(t){var e;return r(this,n),(e=s(this,o(n).call(this,t))).add=new p,e}return e(n,Phaser.Plugins.BasePlugin),t(n,[{key:"start",value:function(){this.game.events.once("destroy",this.destroy,this)}},{key:"preload",value:function(t,e){return l.call(t.sys.load,e),this}}]),n}(),E={quickLogin:function(t,e){return Parse.User.logOut().then(function(){return Parse.User.logIn(t,e)}).catch(function(){return K(t,e)})}};return Object.assign(R.prototype,E),R});
