!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.rexcsvscenarioplugin=e():t.rexcsvscenarioplugin=e()}(window,function(){return function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=53)}({1:function(t,e,s){"use strict";e.a=function(t){return"[object Array]"===Object.prototype.toString.call(t)}},17:function(t,e,s){"use strict";e.a=function(t,e,s,i){e=e||",";for(var r=new RegExp("(\\"+e+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+e+"\\r\\n]*))","gi"),n=[],a=[n],o=null;o=r.exec(t);){var h=o[1];if(h.length&&h!=e&&(n=[],a.push(n)),o[2])var u=o[2].replace(new RegExp('""',"g"),'"');else u=o[3];s&&(u=i?s.call(i,u):s(u)),n.push(u)}return a}},3:function(t,e,s){"use strict";var i=s(1);e.a=function(t){if(Object(i.a)(t))t.length=0;else for(var e in t)delete t[e]}},4:function(t,e,s){"use strict";var i=s(3),r=s(1);e.a=function(t,e){var s,n=Object(r.a)(t);for(var a in null!=e?(s=e,Object(i.a)(s)):s=n?[]:{},n&&(s.length=t.length),t)s[a]=t[a];return s}},53:function(t,e,s){"use strict";s.r(e);var i=s(17),r=s(4),n=s(3);const a=Phaser.Utils.Objects.GetValue;var o=class{constructor(t){this.scenario=t,this.queue=[],this.currentIdx=-1,this.nextIdx=0}resetFromJSON(t){var e=a(t,"queue",void 0);return void 0===e?Object(n.a)(this.queue):Object(r.a)(e,this.queue),this.currentIdx=a(t,"curIdx",-1),this.nextIdx=a(t,"nextIdx",0),this}clean(){return this.currentIdx=-1,this.nextIdx=0,this.queue.length=0,this}append(t){return this.queue.push(t),this}setNextIndex(t){return void 0===t&&(t=this.currentIdx+1),this.nextIdx=t,this}get(t){return void 0===t&&(t=this.nextIdx),this.currentIdx=t,this.queue[t]}get length(){return this.queue.length}};var h=class{constructor(t,e){this.scenario=t,this.type=e}resetFromJSON(t){}toJSON(){return{}}parse(t,e){return t}run(t){}},u=(s(6),s(9)),l=s(7);const c=Phaser.Utils.Array.SpliceOne;var d=class extends h{constructor(t){super(t,"-"),this.task=void 0}resetFromJSON(t){this.task&&(this.task.off("complete",this.resume,this),this.task=void 0)}parse(t,e){var s=c(t,0),i=this.scenario,r=i.argsConvert,n=i.argsConvertScope;if(r){!0===r&&(r=l.a,n=void 0);for(var a=1,o=t.length;a<o;a++)t[a]=n?r.call(n,t[a],t):r(t[a],t)}return t=[s,t]}run(t){var e=this.scenario,s=Object(u.a)(t[1],e.scope);s&&"function"==typeof s.once?(s.once("complete",this.resume,this),this.pause(),this.task=s):this.task=void 0}pause(){this.scenario.pause()}resume(){this.task=void 0;var t=this.scenario;t.resume(),t.runNextCmd()}};var p=class extends h{constructor(t){super(t,"wait")}parse(t,e){t.length=2;var s=this.getEventName(t);return isNaN(s)||(t[1]=parseFloat(s)),t}run(t){var e=this.getEventName(t);"number"==typeof e?this.waitTime(e):this.waitEvent(e)}waitTime(t){t>this.scenario.offset?(t-=this.scenario.offset,this.scenario.offset=0,this.scenario.isDebugMode&&this.scenario.log("#WAIT: "+t),this.scenario.wait(t)):this.scenario.offset-=t}waitEvent(t){this.scenario.isDebugMode&&this.scenario.log("#WAIT: "+t),this.scenario.wait(t)}getEventName(t){var e=t[1];return null==e&&(e="",t[1]=e),e}};const v=Phaser.Utils.Objects.GetValue;var m=class extends h{constructor(t){super(t,"label"),this.labels={},this.prevLabel="",this.lastLabel=""}resetFromJSON(t){this.prevLabel=v(t,"preLabel",""),this.lastLabel=v(t,"lastLabel","");var e=v(t,"labels",void 0);void 0===e?Object(n.a)(this.labels):Object(r.a)(e,this.labels)}toJSON(){return{preLabel:this.prevLabel,lastLabel:this.lastLabel,labels:this.labels}}parse(t,e){t.length=2;var s=this.getLabel(t);return this.addLabel(s,e),t}run(t){var e=this.getLabel(t);this.scenario.isDebugMode&&this.scenario.log("#LABEL: "+e),this.prevLabel=this.lastLabel,this.lastLabel=e;var s=this.scenario;s.emit("labelchange",this.lastLabel,this.prevLabel,s)}getLabel(t){var e=t[1];return null==e&&(e="",t[1]=e),e}addLabel(t,e){this.labels[t]=e}getIndex(t){return""!==t&&this.hasLabel(t)?this.labels[t]:0}hasLabel(t){return this.labels.hasOwnProperty(t)}};var g=class extends h{constructor(t){super(t,"exit")}parse(t,e){return t.length=1,t}run(t){this.scenario.log("#EXIT"),this.scenario.complete()}};var f=class extends h{constructor(t){super(t,"goto")}parse(t,e){return t.length=2,t}run(t){var e=this.getLabel(t);this.scenario.isDebugMode&&this.scenario.log("#GOTO label: "+e),this.scenario.goto(e)}getLabel(t){var e=t[1];return null==e&&(e="",t[1]=e),e}};var b=class extends h{constructor(t){super(t,"if")}parse(t,e){t.length=4;var s="("+this.getCond(t)+")";return t[1]=new Function("return "+s),t}run(t){var e=this.getCond(t).call(this.scenario.scope),s=e?this.getTrueLabel(t):this.getFalseLabel(t);""!==s&&(this.scenario.isDebugMode&&this.scenario.log("#IF "+e+"- GOTO label: "+s),this.scenario.goto(s))}getCond(t){var e=t[1];return null!=e&&""!==e||(e="true",t[1]=e),e}getTrueLabel(t){var e=t[2];return null==e&&(e="",t[2]=e),e}getFalseLabel(t){var e=t[3];return null==e&&(e="",t[3]=e),e}};const x=Phaser.Utils.Objects.GetValue;var O=class{constructor(t){this.cmds={"-":new d(t),wait:new p(t),label:new m(t),exit:new g(t),goto:new f(t),if:new b(t)}}resetFromJSON(t){for(var e in this.cmds)this.cmds[e].resetFromJSON(x(t,e,void 0));return this}toJSON(){var t={};for(var e in this.cmds)t[e]=this.cmds[e].toJSON();return t}get(t){return this.cmds[t]}isValidCmdName(t){return this.cmds.hasOwnProperty(t)}};const C=Phaser.Events.EventEmitter,w=Phaser.Utils.Objects.GetValue;const L={ms:0,s:1,sec:1},y=/^#([a-zA-Z]+)/;var S=class extends C{constructor(t,e){super(),this.scene=t,this.timer=void 0,this.instMem=new o(this),this.cmdHandlers=new O(this),this.resetFromJSON(e),this.boot()}resetFromJSON(t){return this._inRunCmdLoop=!1,this.isRunning=w(t,"state",!1),this.isPaused=w(t,"pause",!1),this.waitEvent=w(t,"wait",void 0),this.scope=w(t,"scope",void 0),this.timeUnit=w(t,"timeUnit",0),this.cmdPrefix=w(t,"prefix",y),this.argsConvert=w(t,"argsConvert",!0),this.argsConvertScope=w(t,"argsConvertScope",void 0),this.cmdHandlers.resetFromJSON(w(t,"handlers",void 0)),this.instMem.resetFromJSON(w(t,"instMem",void 0)),this}toJSON(){return{state:this.isRunning,pause:this.isPaused,wait:this.waitEvent,scope:this.scope,timeUnit:this.timeUnit,prefix:this.cmdPrefix,argsConvert:this.argsConvert,argsConvertScope:this.argsConvertScope,handlers:this.cmdHandlers.toJSON(),instMem:this.instMem.toJSON()}}boot(){}shutdown(){super.shutdown(),this.clean(),this.parent=void 0}destroy(){this.shutdown()}load(t,e,s){return this.clean(),this.timeUnit=w(s,"timeUnit",this.timeUnit),"string"==typeof this.timeUnit&&(this.timeUnit=L[this.timeUnit]),this.cmdPrefix=w(s,"prefix",this.cmdPrefix),"string"==typeof this.cmdPrefix&&(this.cmdPrefix=new RegExp(this.cmdPrefix)),this.argsConvert=w(s,"argsConvert",this.argsConvert),this.argsConvertScope=w(s,"argsConvertScope",this.argsConvertScope),this.scope=e,this.append(t),this}clean(){this.stop(),this.instMem.resetFromJSON(),this.cmdHandlers.resetFromJSON()}start(t){this.stop();var e=w(t,"label","");return this.offset=w(t,"offset",0),this.isDebugMode&&this.log("Start at Label: "+e),!!this.goto(e)&&(this.isRunning=!0,this.runNextCmd(),!0)}getIndex(t){var e=this.getCmdHandler("label").getIndex(t);return null==e&&this.error("Label: "+t+" is not found"),e}goto(t){var e;return null!=(e="string"==typeof t?this.getIndex(t):t)&&(this.instMem.setNextIndex(e),!0)}wait(t){if(this.waitEvent=t,"number"==typeof t){var e=t;1===this.timeUnit&&(e*=1e3),this.timer=this.scene.time.delayedCall(e,this.continue,[t],this)}return this}stop(){return this.isRunning?(this.isRunning=!1,this.isPaused=!1,this.waitEvent=void 0,this.timer&&(this.timer.remove(),this.timer=void 0),this):this}complete(){return this.emit("complete",this),this.stop(),this}append(t){return this.parse(Object(i.a)(t)),this}pause(){return this.isRunning?this.isPaused?this:(this.isPaused=!0,this.timer&&(this.timer.paused=!0),this):this}resume(){return this.isRunning&&this.isPaused?(this.isPaused=!1,this.timer&&(this.timer.paused=!1),this):this}continue(t){return!this.isRunning||this.isPaused||void 0===this.waitEvent?this:(t===this.waitEvent&&(this.timer=void 0,this.waitEvent=void 0,this.runNextCmd()),this)}get lastLabel(){return this.cmdHandlers.labelCmd.lastLabel}get previousLabel(){return this.cmdHandlers.labelCmd.preLabel}getCmdHandler(t){return"string"!=typeof t&&(t=t[0]),this.cmdHandlers.get(t)}parse(t){for(var e,s,i=this.cmdPrefix,r=0,n=t.length;r<n;r++)if("-"===(s=(e=t[r])[0]))this.appendCommand(e);else if(isNaN(s))if(i.test(s)){var a=s.match(i);e[0]=a[1].toLowerCase(),this.appendCommand(e)||this.error("Line "+r+": "+JSON.stringify(e)+" is not a valid command")}else this.appendCommand(["wait",s]),e[0]="-",this.appendCommand(e);else{var o=parseFloat(s);o>0&&this.appendCommand(["wait",o]),e[0]="-",this.appendCommand(e)}return this}appendCommand(t){var e=this.getCmdHandler(t);return null!=e&&((t=e.parse(t,this.instMem.length))&&this.instMem.append(t),!0)}runNextCmd(){if(!this._inRunCmdLoop){this.threadId;var t,e=this.instMem;for(this._inRunCmdLoop=!0;this.isRunning&&!this.isPaused&&void 0===this.waitEvent;){if(t=e.get(),e.setNextIndex(),null==t){this.complete();break}this.getCmdHandler(t).run(t)}return this._inRunCmdLoop=!1,this}}log(t){return this.emit("log",t,this),this}get isDebugMode(){return this.listenerCount("log")>0}error(t){return this.emit("error",t,this),this}};e.default=class extends Phaser.Plugins.BasePlugin{constructor(t){super(t)}start(){this.game.events.once("destroy",this.destroy,this)}add(t,e){return new S(t,e)}}},6:function(t,e,s){"use strict";e.a=function(t,e,s,i){void 0===s&&(s=0),void 0===i&&(i=e.length),t.length=i-s;for(var r=0,n=t.length;r<n;r++)t[r]=e[r+s];return t}},7:function(t,e,s){"use strict";var i=/^\s*-?(\d*\.?\d+|\d+\.?\d*)(e[-+]?\d+)?\s*$/i;e.a=function(t){return"string"!=typeof t?t:(""===t?t=null:i.test(t)?t=parseFloat(t):"false"===screen?t=!1:"true"===t&&(t=!0),t)}},9:function(t,e,s){"use strict";var i=s(6),r=s(7);const n=Phaser.Utils.Objects.GetValue;var a=function(t,e,s){var i,r=n(s,"reverse",!1);if("string"==typeof t[0])i=o(t,e,s);else if(r)for(h=(u=t.length)-1;h>=0;h--)i=a(t[h],e,s);else for(var h=0,u=t.length;h<u;h++)i=a(t[h],e,s);return i},o=function(t,e,s){var a=n(s,"argsConvert",void 0),o=n(s,"argsConvertScope",void 0),u=t[0];if(h=Object(i.a)(h,t,1),a){!0===a&&(a=r.a,o=void 0);for(var l=0,c=h.length;l<c;l++)h[l]=o?a.call(o,h[l],t):a(h[l],t)}var d=e[u];return null==d&&(d=n(e,u,null)),e?d.apply(e,h):d(h)},h=[],u=a;e.a=u}}).default});