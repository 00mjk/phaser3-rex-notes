!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e="undefined"!=typeof globalThis?globalThis:e||self).rexhorrifipipelineplugin=n()}(void 0,function(){function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,n,t){return n&&i(e.prototype,n),t&&i(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&t(e,n)}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function t(e,n){return(t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,n){return e.__proto__=n,e})(e,n)}function u(e,n){if(n&&("object"==typeof n||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(i){var o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,n=a(i);if(o){var t=a(this).constructor;e=Reflect.construct(n,arguments,t)}else e=n.apply(this,arguments);return u(this,e)}}var e={setBloomEnable:function(e){return void 0===e&&(e=!0),this.enableBloom=e,this},setBloomRadius:function(e){return this.bloomRadius=e,this},setBloomIntensity:function(e){return this.bloomIntensity=e,this},setBloomThreshold:function(e){return this.bloomThreshold=e,this}},n={setChromaticEnable:function(e){return void 0===e&&(e=!0),this.enableChromatic=e,this},setChabIntensity:function(e){return this.chabIntensity=e,this}},c={setVignetteEnable:function(e){return void 0===e&&(e=!0),this.enableVignette=e,this},setVignetteStrength:function(e){return this.vignetteStrength=e,this},setVignetteIntensity:function(e){return this.vignetteIntensity=e,this}},h={setNoiseEnable:function(e){return void 0===e&&(e=!0),this.enableNoise=e,this},setNoiseStrength:function(e){return this.noiseStrength=e,this}},v={setVHSEnable:function(e){return void 0===e&&(e=!0),this.enableVHS=e,this},setVhsStrength:function(e){return this.vhsStrength=e,this}},m={setScanlinesEnable:function(e){return void 0===e&&(e=!0),this.enableScanlines=e,this},setScanStrength:function(e){return this.scanStrength=e,this}},b={setCRTEnable:function(e){return void 0===e&&(e=!0),this.enableCRT=e,this},setCrtSize:function(e,n){return this.crtWidth=e,this.crtHeight=n,this}},p={};Object.assign(p,e,n,c,h,v,m,b);var g=Phaser.Renderer.WebGL.Pipelines.PostFXPipeline,d=Phaser.Utils.Objects.GetValue,y=function(){s(i,g);var t=f(i);function i(e){var n;return o(this,i),(n=t.call(this,{name:"rexHorrifiPostFx",game:e,renderTarget:!0,fragShader:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n#define highmedp highp\n#else\n#define highmedp mediump\n#endif\nprecision highmedp float;\n\nuniform float seed;\nuniform float time;\n\n// Scene buffer\nuniform sampler2D uMainSampler; \nvarying vec2 outTexCoord;\n\n// Effect parameters\n#define SAMPLES 32.\n\n// Bloom\nuniform float enableBloom;\nuniform vec3 bloom;\nuniform vec2 bloomTexel;\n\n// Chromatic abberation\nuniform float enableChromatic;\nuniform float chabIntensity;\n\n// Vignette\nuniform float enableVignette;\nuniform vec2 vignette;\n\n// Noise\nuniform float enableNoise;\nuniform float noiseStrength;\n\n// VHS\nuniform float enableVHS;\nuniform float vhsStrength;\n\n// Scanlines\nuniform float enableScanlines;\nuniform float scanStrength;\n\n// CRT\nuniform float enableCRT;\nuniform vec2 crtSize;\n\n\n// Noise\nfloat noise(vec2 uv) {\n  return fract(sin(uv.x*12.9898+uv.y*78.233)*437.585453*seed);\n}\n\n// VHS\nvec4 vhs(vec2 uv) {\n  vec2 tcoord = uv;\n  tcoord.x += sin(time*noise(uv));\n  return texture2D( uMainSampler, tcoord)*vhsStrength;\t\n}\n\n// Vignette\nfloat vig(vec2 uv) {\n  uv *= 1. - uv;\n  return ( pow(uv.x*uv.y*vignette.x*10.,vignette.y) );\n}\n\n// Chromatic abberation\nvec3 chromatic(vec2 uv, float offset) {\n  float r = texture2D( uMainSampler, vec2(uv.x+offset, uv.y)).r;\n  float g = texture2D( uMainSampler, uv).g;\n  float b = texture2D( uMainSampler, vec2(uv.x-offset, uv.y)).b;\n  return vec3(r,g,b);\n}\n\n// Bloom\nvec4 blur(vec2 uv) {\n  float total = 0.;\n  float rad = 1.;\n  mat2 ang = mat2(.73736882209777832,-.67549037933349609,.67549037933349609,.73736882209777832);\n  vec2 point = normalize(fract(cos(uv*mat2(195,174,286,183))*742.)-.5)*(bloom.x/sqrt(SAMPLES));\n  vec4 amount = vec4(0);\n\t\n  for ( float i=0.; i<SAMPLES; i++ ) {\n    point*=ang;\n    rad+=1./rad;\n    vec4 samp = texture2D(uMainSampler, uv + point * (rad-1.) * bloomTexel);\n    \n    float mul = 1.;\n    float lum = ( samp.r+samp.g+samp.b )/3.;\n    if ( lum < bloom.z ){ mul = 0.; }\n    \n    amount += samp*(1./rad)*mul;\n    total+=(1./rad);\n  }\n  amount /= total;\n  return amount*bloom.y;\n}\n\n// TV Curve\nvec2 crtRunCurve( vec2 uv ) {\n  uv = uv*2.-1.;\n  vec2 uvoff = abs(uv.xy) / crtSize;\n  uv = uv + uv * uvoff * uvoff;\n  uv = uv * .5 + .5;\n  return uv;\n}\n\nvoid main() {\t\n  vec2 mainUv = outTexCoord;\n\n  // CRT\n  if ( enableCRT > .5 ) {\n    mainUv = crtRunCurve(outTexCoord);\n  }\n\t\n  // Base coloring\n  vec4 color = texture2D( uMainSampler, mainUv);\n\t\n  // Chromatic abberation\n  if ( enableChromatic > .5 ) {\n    color.rgb *= chromatic(mainUv, chabIntensity * 0.01);\n  }\n\t\n  // Scanlines\n  if ( enableScanlines > .5 ) {\n    color.rgb *= (1.-scanStrength)+(sin(mainUv.y*1024.)*scanStrength);\n  }\n\n  // Bloom\n  if ( enableBloom > .5 ) {\n    color.rgb += blur(mainUv).rgb;\n  }\n\t\n  // Noise\n  if ( enableNoise > .5 ) {\n    color.rgb += noise(mainUv)*noiseStrength;\n  }\n\t\n  // VHS\n  if ( enableVHS > .5 ) {\n    color += vhs(mainUv);\n  }\n\t\n  // Vignette\n  if ( enableVignette > .5) {\n    color.rgb *= vig(mainUv);\n  }\n\t\n  // Cutoff edges\n  if ( enableCRT > .5) {\n    if ( (mainUv.x < 0.)|| (mainUv.y < 0.) || (mainUv.x > 1.)|| (mainUv.y > 1.) ) {\n      color.rgb *= 0.;\n    }\n  }\n\t\n  gl_FragColor = color;\n}\n"})).seed=Math.random(),n.now=0,n.enableBloom=!1,n.bloomRadius=0,n.bloomIntensity=0,n.bloomThreshold=0,n.bloomTexelX=0,n.bloomTexelY=0,n.enableChromatic=!1,n.chabIntensity=0,n.enableVignette=!1,n.vignetteStrength=0,n.vignetteIntensity=0,n.enableNoise=!1,n.noiseStrength=0,n.enableVHS=!1,n.vhsStrength=0,n.enableScanlines=!1,n.scanStrength=0,n.enableCRT=!1,n.crtWidth=1,n.crtHeight=1,n}return r(i,[{key:"resetFromJSON",value:function(e){var n=d(e,"enable",!1);return this.setBloomEnable(d(e,"bloomEnable",n)),this.setBloomRadius(d(e,"bloomRadius",0)),this}},{key:"onPreRender",value:function(){this.set1f("seed",this.seed),this.set1f("enableBloom",this.enableBloom?1:0),this.set3f("bloom",this.bloomRadius,this.bloomIntensity,this.bloomThreshold),this.set2f("bloomTexel",this.bloomTexelX,this.bloomTexelY),this.set1f("enableChromatic",this.enableChromatic?1:0),this.set1f("chabIntensity",this.chabIntensity),this.set1f("enableVignette",this.enableVignette?1:0),this.set2f("vignette",this.vignetteStrength,this.vignetteIntensity),this.set1f("enableNoise",this.enableNoise?1:0),this.set1f("noiseStrength",this.noiseStrength),this.set1f("enableVHS",this.enableVHS?1:0),this.set1f("vhsStrength",this.vhsStrength),this.set1f("enableScanlines",this.enableScanlines?1:0),this.set1f("scanStrength",this.scanStrength),this.set1f("enableCRT",this.enableCRT?1:0),this.set2f("crtSize",this.crtWidth,this.crtHeight),this.enableVHS&&(this.now+=this.game.loop.delta),this.set1f("time",this.now)}}]),i}();Object.assign(y.prototype,p);function S(e){return e instanceof C}function P(e){return S(e)?e:S(e.game)?e.game:e.scene instanceof T?e.scene.game:void 0}function x(e){return null==e||""===e||0===e.length}var C=Phaser.Game,T=Phaser.Scene,R=Phaser.Utils.Array.SpliceOne,V=function(){s(n,Phaser.Plugins.BasePlugin);var e=f(n);function n(){return o(this,n),e.apply(this,arguments)}return r(n,[{key:"setPostPipelineClass",value:function(e,n){return this.PostFxPipelineClass=e,this.postFxPipelineName=n,this}},{key:"start",value:function(){var e,n,t;this.game.events.once("destroy",this.destroy,this),e=this.game,n=this.postFxPipelineName,t=this.PostFxPipelineClass,P(e).renderer.pipelines.addPostPipeline(n,t)}},{key:"add",value:function(e,n){return function(e,n,t){void 0===t&&(t={}),e.setPostPipeline(n);var i=e.postPipelines[e.postPipelines.length-1];return i.resetFromJSON(t),t.name&&(i.name=t.name),i}(e,this.PostFxPipelineClass,n)}},{key:"remove",value:function(e,n){return function(e,n,t){if(void 0===t)for(var i=(o=e.postPipelines).length-1;0<=i;i--){(s=o[i])instanceof n&&(s.destroy(),R(o,i))}else{i=0;for(var o,r=(o=e.postPipelines).length;i<r;i++){var s;(s=o[i])instanceof n&&s.name===t&&(s.destroy(),R(o,i))}}}(e,this.PostFxPipelineClass,n),this}},{key:"get",value:function(e,n){return function(e,n,t){if(void 0===t){for(var i=[],o=0,r=(s=e.postPipelines).length;o<r;o++){(a=s[o])instanceof n&&i.push(a)}return i}var s;for(o=0,r=(s=e.postPipelines).length;o<r;o++){var a;if((a=s[o])instanceof n&&a.name===t)return a}}(e,this.PostFxPipelineClass,n)}}]),n}(),O=function(){s(i,V);var t=f(i);function i(e){var n;return o(this,i),(n=t.call(this,e)).setPostPipelineClass(y,"rexHorrifiPostFx"),n}return r(i)}();return function(e,n,t,i){if(void 0===i&&(i="."),"object"===l(e)){if(x(n)){if(null==t)return;"object"===l(t)&&(e=t)}else{"string"==typeof n&&(n=n.split(i));var o=n.pop();(function(e,n,t){var i=e;if(!x(n)){var o;"string"==typeof n&&(n=n.split("."));for(var r=0,s=n.length;r<s;r++){var a;if(null==i[o=n[r]]||"object"!==l(i[o]))a=r!==s-1||void 0===t?{}:t,i[o]=a;i=i[o]}}return i})(e,n)[o]=t}}}(window,"RexPlugins.Pipelines.HorrifiPostFx",y),O});
