!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).rexshatterimageplugin=e()}(this,function(){"use strict";function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function h(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function t(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function c(n){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=o(n);if(i){var r=o(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return s(this,t)}}function T(t){var e,r,n,i,o,s,a=t.rectangle;s=a?(e=a.x,n=a.y,o=a.width,a.height):(n=e=0,o=t.width,t.height),r=e+o,i=n+s;var u,h,c=t.center;h=void 0===c?(u=(e+r)/2,(n+i)/2):(u=w(c.x,e,r),w(c.y,n,i));var f=[];f.push([u,h]);for(var l=P(t,"samples",12),p=P(t,"variation",.25),g=Math.min(o,s),v=1-p,y=1+p,m=0;m<3;m++)x(f,u,h,g*Math.pow(3,m)/27,l,v,y,e,r,n,i);return g=2*Math.min(o,s),x(f,u,h,g,l,v,y,e,r,n,i),function(t,e){void 0===e&&(e=!0);var r=d.triangulate(t);if(e){for(var n=[],i=0,o=r.length;i<o;i+=3){var s=t[r[i+0]],a=t[r[i+1]],u=t[r[i+2]],h=new b(s[0],s[1],a[0],a[1],u[0],u[1]);n.push(h)}return n}return{vertices:t,indices:r}}(f,P(t,"triangleOutput",!0))}var i,d=(function(t){var e,x;function v(t,e,r,n){var i,o,s,a,u,h,c,f,l,p,g=t[e][0],v=t[e][1],y=t[r][0],m=t[r][1],d=t[n][0],b=t[n][1],P=Math.abs(v-m),w=Math.abs(m-b);if(P<x&&w<x)throw new Error("Eek! Coincident points!");return o=P<x?(a=-(d-y)/(b-m))*((i=(y+g)/2)-(h=(y+d)/2))+(f=(m+b)/2):w<x?(s=-(y-g)/(m-v))*((i=(d+y)/2)-(u=(g+y)/2))+(c=(v+m)/2):(i=((s=-(y-g)/(m-v))*(u=(g+y)/2)-(a=-(d-y)/(b-m))*(h=(y+d)/2)+(f=(m+b)/2)-(c=(v+m)/2))/(s-a),w<P?s*(i-u)+c:a*(i-h)+f),{i:e,j:r,k:n,x:i,y:o,r:(l=y-i)*l+(p=m-o)*p}}function y(t){var e,r,n,i,o,s;for(r=t.length;r;)for(i=t[--r],n=t[--r],e=r;e;)if(s=t[--e],n===(o=t[--e])&&i===s||n===s&&i===o){t.splice(r,2),t.splice(e,2);break}}x=1/1048576,e={triangulate:function(r,t){var e,n,i,o,s,a,u,h,c,f,l,p,g=r.length;if(g<3)return[];if(r=r.slice(0),t)for(e=g;e--;)r[e]=r[e][t];for(i=new Array(g),e=g;e--;)i[e]=e;for(i.sort(function(t,e){return r[e][0]-r[t][0]}),o=function(t){var e,r,n,i,o,s,a=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(e=t.length;e--;)t[e][0]<a&&(a=t[e][0]),t[e][0]>h&&(h=t[e][0]),t[e][1]<u&&(u=t[e][1]),t[e][1]>c&&(c=t[e][1]);return n=c-u,[[(o=a+.5*(r=h-a))-20*(i=Math.max(r,n)),(s=u+.5*n)-i],[o,s+20*i],[o+20*i,s-i]]}(r),r.push(o[0],o[1],o[2]),s=[v(r,g+0,g+1,g+2)],a=[],u=[],e=i.length;e--;u.length=0){for(p=i[e],n=s.length;n--;)0<(h=r[p][0]-s[n].x)&&h*h>s[n].r?(a.push(s[n]),s.splice(n,1)):h*h+(c=r[p][1]-s[n].y)*c-s[n].r>x||(u.push(s[n].i,s[n].j,s[n].j,s[n].k,s[n].k,s[n].i),s.splice(n,1));for(y(u),n=u.length;n;)l=u[--n],f=u[--n],s.push(v(r,f,l,p))}for(e=s.length;e--;)a.push(s[e]);for(s.length=0,e=a.length;e--;)a[e].i<g&&a[e].j<g&&a[e].k<g&&s.push(a[e].i,a[e].j,a[e].k);return s},contains:function(t,e){if(e[0]<t[0][0]&&e[0]<t[1][0]&&e[0]<t[2][0]||e[0]>t[0][0]&&e[0]>t[1][0]&&e[0]>t[2][0]||e[1]<t[0][1]&&e[1]<t[1][1]&&e[1]<t[2][1]||e[1]>t[0][1]&&e[1]>t[1][1]&&e[1]>t[2][1])return null;var r=t[1][0]-t[0][0],n=t[2][0]-t[0][0],i=t[1][1]-t[0][1],o=t[2][1]-t[0][1],s=r*o-n*i;if(0==s)return null;var a=(o*(e[0]-t[0][0])-n*(e[1]-t[0][1]))/s,u=(r*(e[1]-t[0][1])-i*(e[0]-t[0][0]))/s;return a<0||u<0||1<a+u?null:[a,u]}},t.exports=e}(i={exports:{}}),i.exports),b=Phaser.Geom.Triangle,P=Phaser.Utils.Objects.GetValue,w=Phaser.Math.Clamp,v=2*Math.PI,x=function(t,e,r,n,i,o,s,a,u,h,c){for(var f=0;f<i;f++){var l=f/i*v,p=e+Math.cos(l)*n*y(o,s),g=r+Math.sin(l)*n*y(o,s);p=w(p,a,u),g=w(g,h,c),t.push([p,g])}return t},y=function(t,e){return t===e?t:t+(e-t)*Math.random()},a=Phaser.Geom.Mesh.Face,f=Phaser.Math.DegToRad,l=Phaser.Math.RadToDeg,p=Phaser.Geom.Mesh.RotateFace,G=function(){e(o,a);var i=c(o);function o(t,e,r){var n;return h(this,o),(n=i.call(this,t,e,r))._rotation=0,n}return t(o,[{key:"setRotation",value:function(t){return this.rotation=t,this}},{key:"setAngle",value:function(t){return this.angle=t,this}},{key:"rotation",get:function(){return this._rotation},set:function(t){p(this,t-this._rotation),this._rotation=t}},{key:"angle",get:function(){return l(this.rotation)},set:function(t){this.rotation=f(t)}}]),o}(),g=Phaser.GameObjects.Mesh,m=Phaser.Utils.Objects.IsPlainObject,j=Phaser.Utils.Objects.GetValue,I=Phaser.Geom.Mesh.GenerateGridVerts,_=Phaser.Geom.Mesh.Vertex,N=Phaser.Math.Distance.Squared,O=Phaser.Math.DegToRad,M=1+1/Math.sin(O(45)),k=function(){e(u,g);var a=c(u);function u(t,e,r,n,i,o){var s;return h(this,u),m(e)&&(e=j(o=e,"x",0),r=j(o,"y",0),n=j(o,"key",null),i=j(o,"frame",null)),(s=a.call(this,t,e,r,n,i)).type="rexShatterImage",s.setSizeToFrame(),s.setPerspective(s.width,s.height,45),s.panZ(M),s.resetImage(),s.shatterCenter={x:null,y:null},s}return t(u,[{key:"resetImage",value:function(){return this.clear(),this.dirtyCache[9]=-1,I({mesh:this,texture:this.texture.key,frame:this.frame.name,width:this.frame.cutWidth/this.height,height:this.frame.cutHeight/this.height,flipY:this.frame.source.isRenderTexture}),this}},{key:"shatter",value:function(t,e){if(void 0===t&&(t=this.width/2,e=this.height/2),this.shatterCenter.x=t,this.shatterCenter.y=e,this.clear(),this.dirtyCache[9]=-1,0===this.width||0===this.height)return this;for(var r=T({width:this.width,height:this.height,center:this.shatterCenter,triangleOutput:!1}),n=r.vertices,i=r.indices,o=[],s=this.width,a=this.height,u=this.frame.cutWidth/a/2,h=this.frame.cutHeight/a/2,c=this.frame.source.isRenderTexture,f=this.frame.u0,l=this.frame.u1,p=c?this.frame.v1:this.frame.v0,g=l-f,v=(c?this.frame.v0:this.frame.v1)-p,y=0,m=n.length;y<m;y++){var d=n[y],b=d[0],P=d[1];o.push({g:N(t,e,b,P),x:b/a-u,y:P/a-h,u:f+b/s*g,v:p+P/a*v})}for(y=0,m=i.length;y<m;y+=3){var w=o[i[y+0]],x=o[i[y+1]],j=o[i[y+2]],I=new _(w.x,-w.y,0,w.u,w.v),O=new _(x.x,-x.y,0,x.u,x.v),M=new _(j.x,-j.y,0,j.u,j.v),k=new G(I,O,M);this.vertices.push(I,O,M),this.faces.push(k),k.g=Math.min(w.g,x.g,j.g)}return this.faces.sort(function(t,e){return t.g-e.g}),this}},{key:"startUpdate",value:function(){return this.ignoreDirtyCache=!0,this}},{key:"stopUpdate",value:function(){return this.ignoreDirtyCache=!1,this}}]),u}();function R(t,e,r,n,i){var o=new k(this.scene,t,e,r,n,i);return this.scene.add.existing(o),o}var S=Phaser.Utils.Objects.GetAdvancedValue,C=Phaser.GameObjects.BuildGameObject;function E(t,e){void 0===t&&(t={}),void 0!==e&&(t.add=e);var r=S(t,"key",null),n=S(t,"frame",null),i=new k(this.scene,0,0,r,n,t);return C(this.scene,i,t),i}function V(t){return null==t||""===t||0===t.length}var D=function(){e(n,Phaser.Plugins.BasePlugin);var r=c(n);function n(t){var e;return h(this,n),e=r.call(this,t),t.registerGameObject("rexShatterImage",R,E),e}return t(n,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}}]),n}();return function(t,e,r){if("object"===u(t)){if(V(e)){if(null==r)return;"object"===u(r)&&(t=r)}else{"string"==typeof e&&(e=e.split("."));var n=e.pop();(function(t,e,r){var n=t;if(!V(e)){var i;"string"==typeof e&&(e=e.split("."));for(var o=0,s=e.length;o<s;o++){var a;if(null==n[i=e[o]]||"object"!==u(n[i]))a=o!==s-1||void 0===r?{}:r,n[i]=a;n=n[i]}}return n})(t,e)[n]=r}}}(window,"RexPlugins.GameObjects.ShatterImage",k),D});
